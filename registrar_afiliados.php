<?php header( "Expires: Mon, 26 Jul 1997 05:00:00 GMT" ); // disable IE cachingheader( "Last-Modified: " . gmdate( "D, d M Y H:i:s" ) . "GMT" );header( "Cache-Control: no-cache, must-revalidate" );header( "Pragma: no-cache" );header('Content-Type: text/html; charset=UTF-8');include("admin/libs/util/mmail.php");include("admin/libs/actions/triggers.php");include("assets/util.php");function validar_clave($clave,&$error_clave){   if(strlen($clave) < 6){      $error_clave = "La clave debe tener al menos 6 caracteres";      return false;   }   if(strlen($clave) > 16){      $error_clave = "La clave no puede tener m�s de 16 caracteres";      return false;   }   /*if (!preg_match('`[a-z]`',$clave)){      $error_clave = "La clave debe tener al menos una letra min�scula";      return false;   }   if (!preg_match('`[A-Z]`',$clave)){      $error_clave = "La clave debe tener al menos una letra may�scula";      return false;   }   if (!preg_match('`[0-9]`',$clave)){      $error_clave = "La clave debe tener al menos un caracter num�rico";      return false;   }*/   $error_clave = "";   return true;} function comprobar_email($email){    $mail_correcto = 0;    //compruebo unas cosas primeras    if ((strlen($email) >= 6) && (substr_count($email,"@") == 1) && (substr($email,0,1) != "@") && (substr($email,strlen($email)-1,1) != "@")){       if ((!strstr($email,"'")) && (!strstr($email,"\"")) && (!strstr($email,"\\")) && (!strstr($email,"\$")) && (!strstr($email," "))) {          //miro si tiene caracter .          if (substr_count($email,".")>= 1){             //obtengo la terminacion del dominio             $term_dom = substr(strrchr ($email, '.'),1);             //compruebo que la terminaci�n del dominio sea correcta             if (strlen($term_dom)>1 && strlen($term_dom)<5 && (!strstr($term_dom,"@")) ){                //compruebo que lo de antes del dominio sea correcto                $antes_dom = substr($email,0,strlen($email) - strlen($term_dom) - 1);                $caracter_ult = substr($antes_dom,strlen($antes_dom)-1,1);                if ($caracter_ult != "@" && $caracter_ult != "."){                   $mail_correcto = 1;                }             }          }       }    }    if ($mail_correcto)       return true;    else       return false;} include("back/config/database.php");if(!isset($_POST['c'])){	//valida todos los campos	if (!comprobar_email($_POST['mail']))		die("mail#No es un email valido");	if(!validar_clave($_POST['passb'],$error))		die("passb#".utf8_encode($error));	$v=$_POST['repass'];	$medio=strlen($v)/2;	if($medio==round($medio,0) && $medio>5 && substr($v,0,$medio)==substr($v,-$medio))		$rt="";	else		die("repass#Las ".utf8_encode("contraseñas")." no son iguales");			if($_POST['deporte']=="")		die("deporte#Campo obligatorio");	if($_POST['equipo']=="")		die("equipo#Campo obligatorio");	$sql="insert into t_login(user, pass, fec_registro) values ";	$sql.="('".$_POST['mail']."',sha1('".$_POST['passb']."'), now())";		$db->show_errors=false;	if ($db->query($sql)){			$idEquipo=$db->insert_id;		$equipo=$_POST['equipo'];		$sql="insert into t_equipos(nom_equipo, id_deporte, user) values ";		$sql.="('".$equipo."',(select id_deporte from t_deportes where deporte='".$_POST['deporte']."'),'".$_POST['mail']."')";		if($db->query($sql)){                        $idEq=$db->insert_id;                        //asegura el nombre                        trigger(10, $idEq, $db);                        if($_POST['torneo']!=""){                            copiarDatosEquipo($_POST['mail'],$_POST['torneo'],$equipo,$idEq);                        }                        			$server="http://".$_SERVER['HTTP_HOST'];			$link=$server."/activacion.php?i=".$idEquipo."&k=".sha1("SalT".$_POST['mail'].sha1($_POST['passb']));			$cuerpo="<div>";			$cuerpo.="<div>Para activar su cuenta solo debe seguir este enlace: </div>";			$cuerpo.="<div><a href='".$link."'>".$link."</a></div>";			$cuerpo.="<div>&nbsp;</div>";			$cuerpo.="<div>Si no ha solicitado este email, ignorelo.</div>";			$cuerpo.="<div>&nbsp;</div>";			$cuerpo.="<div><a href='".$server."'>".$server."</a></div>";			$cuerpo.="</div>";			if ($rt=sendMail($_POST['mail'],utf8_encode("Activa tu cuenta"),utf8_encode($cuerpo)))				$rt="OK";			sendMail("miequipodeportivo@miequipodeportivo.com","Nuevo registro",utf8_encode($_POST['equipo']."<br>".$_POST['mail']));		}else{			$sql="delete from t_login where user='".$_POST['mail']."'";			$db->query($sql);			$rt=$db->last_error;		}	}else{		if (strpos(strtolower($db->last_error),"duplicate entry")>=0)			die("mail#Este Email ya está dado de alta en el sistema");		else			$rt="<br>Ocurrio un error. Intentelo más tarde";	}		$db->show_errors=true;	echo utf8_encode($rt);}else{	switch($_POST['c']){		case 'mail':				if (comprobar_email($_POST['v']))					$rt="OK";				else					$rt="No es un email valido";			break;		case 'passb':			$error="";			if(validar_clave($_POST['v'],$error))				$rt="OK";			else				$rt=$error;			break;		case 'repass':			$v=$_POST['v'];			$medio=strlen($v)/2;			if($medio==round($medio,0) && $medio>5 && substr($v,0,$medio)==substr($v,-$medio))				$rt="OK";			else				$rt="Las contraseñas no son iguales";			break;		case "deporte":			if($_POST['v']!="")				$rt="OK";			else				$rt="Campo obligatorio";			break;		case "equipo":			if($_POST['v']!="")				$rt="OK";			else				$rt="Campo obligatorio";			break;	}		$rt=$_POST['c']."#".$rt;	echo utf8_encode($rt);		}?>